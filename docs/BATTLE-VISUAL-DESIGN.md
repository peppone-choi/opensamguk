# ğŸ—¡ï¸ 2D ì „íˆ¬ ì‹œê°í™” ì„¤ê³„ì„œ

> ì„¤ê³„ë§Œ. ê°œë°œì€ Phase 4 ì´í›„.

---

## í•µì‹¬ ì»¨ì…‰: í„´ì œ â†” ì‹¤ì‹œê°„ ì „íˆ¬ ë¸Œë¦¿ì§€

```
[í„´ì œ ì„¸ê³„]                    [ì „íˆ¬ ì„¸ê³„]                   [í„´ì œ ì„¸ê³„]
                               
 ì¶œë³‘ ì»¤ë§¨ë“œ ì‹¤í–‰ â”€â”€â†’ ì „íˆ¬ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± â”€â”€â†’ 2D ì „íˆ¬ ì‹œë®¬ë ˆì´ì…˜ â”€â”€â†’ ê²°ê³¼ ë°˜ì˜
 (ê¸°ì¡´ ì‹œìŠ¤í…œ)       (íŒŒë¼ë¯¸í„° ì¶”ì¶œ)        (í‹± ê¸°ë°˜ ì—”ì§„)         (ê¸°ì¡´ ì‹œìŠ¤í…œ)
```

**ì›ì¹™**: ì „íˆ¬ëŠ” í„´ì œ ì‹œìŠ¤í…œì˜ "ì¤Œì¸"ì´ë‹¤. ê¸°ì¡´ ì»¤ë§¨ë“œ íë¦„ì„ ê¹¨ì§€ ì•ŠëŠ”ë‹¤.

---

## 1. í„´ì œ â†” ì „íˆ¬ ì—°ë™ ëª¨ë¸

### 1A. ì „íˆ¬ íŠ¸ë¦¬ê±° (ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ ì§„ì…)

í˜„ì¬ íë¦„:
```
che_ì¶œë³‘ â†’ ì´ë™ â†’ ì  ë„ì‹œ ë„ì°© â†’ ì „íˆ¬ íŒì • â†’ ê²°ê³¼ (ìŠ¹/íŒ¨/ë¬´)
```

ìƒˆ íë¦„:
```
che_ì¶œë³‘ â†’ ì´ë™ â†’ ì  ë„ì‹œ ë„ì°© â†’ [ì „íˆ¬ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±] â†’ [2D ì „íˆ¬] â†’ ê²°ê³¼ ë°˜ì˜
                                       â†“
                               BattleScenario {
                                 attackerUnits, defenderUnits,
                                 terrain, weather, walls,
                                 generalStats, items, skills
                               }
```

### 1B. ì „íˆ¬ ëª¨ë“œ ì„ íƒ (ê³µì¡´)

| ëª¨ë“œ | ì„¤ëª… | ìš©ë„ |
|------|------|------|
| **auto** | ê¸°ì¡´ ì¦‰ì‹œ íŒì • (í˜„í–‰) | NPC vs NPC, ë¹ ë¥¸ ì§„í–‰ |
| **replay** | ì‹œë®¬ë ˆì´ì…˜ í›„ ë¦¬í”Œë ˆì´ | í”Œë ˆì´ì–´ ì „íˆ¬ ê¸°ë³¸ê°’ |
| **interactive** | í”Œë ˆì´ì–´ ì¡°ì‘ ê°€ëŠ¥ | í–¥í›„ í™•ì¥ |

```kotlin
// backend - ì „íˆ¬ ëª¨ë“œ ê²°ì •
fun resolveBattle(attacker: Army, defender: Army): BattleResult {
    val scenario = buildScenario(attacker, defender)
    
    return when {
        attacker.isNpc && defender.isNpc -> instantResolve(scenario)  // ê¸°ì¡´ ë°©ì‹
        else -> tickSimulate(scenario)  // ìƒˆ ë°©ì‹: í‹± ë°ì´í„° ìƒì„±
    }
}
```

### 1C. ê²°ê³¼ ë°˜ì˜ (ê¸°ì¡´ ì‹œìŠ¤í…œìœ¼ë¡œ ë³µê·€)

ì „íˆ¬ ê²°ê³¼ëŠ” ë™ì¼í•œ ì¸í„°í˜ì´ìŠ¤ë¡œ ê¸°ì¡´ ì‹œìŠ¤í…œì— ë°˜ì˜:
```kotlin
data class BattleResult(
    val winner: Side,              // ATTACKER | DEFENDER | DRAW
    val attackerLoss: ArmyDelta,   // ë³‘ë ¥/ì‚¬ê¸°/í›ˆë ¨ ë³€í™”
    val defenderLoss: ArmyDelta,
    val generalExp: Map<Long, Int>, // ì¥ìˆ˜ë³„ ê²½í—˜ì¹˜
    val captured: Boolean,          // ë„ì‹œ ì ë ¹ ì—¬ë¶€
    val items: List<ItemDrop>,      // ë…¸íší’ˆ
    val ticks: List<BattleTick>?    // nullì´ë©´ auto ëª¨ë“œ
)
```

ê¸°ì¡´ ì „íˆ¬ í›„ì²˜ë¦¬ ì½”ë“œ(ë„ì‹œ ì ë ¹, ì¥ìˆ˜ í¬ë¡œ, ì•„ì´í…œ ë“œë)ëŠ” **ê·¸ëŒ€ë¡œ ì‚¬ìš©**.

---

## 2. ì „íˆ¬ ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„ (í‹± ê¸°ë°˜)

### 2A. í‹± êµ¬ì¡°

```kotlin
data class BattleTick(
    val tick: Int,           // 0, 1, 2, ...
    val elapsed: Float,      // ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„ (ì´ˆ)
    val units: List<UnitSnapshot>,
    val events: List<BattleEvent>,
    val phase: BattlePhase   // DEPLOY, ENGAGE, MELEE, RETREAT, END
)

data class UnitSnapshot(
    val id: Long,
    val side: Side,
    val type: CrewType,      // ê¸°ë³‘/ë³´ë³‘/ê¶ë³‘/ë…¸ë³‘/...
    val x: Float, val y: Float,
    val hp: Int, val maxHp: Int,
    val morale: Int,
    val state: UnitState     // IDLE, MOVING, ATTACKING, ROUTING, DEAD
)

sealed class BattleEvent {
    data class Attack(val attacker: Long, val target: Long, val damage: Int)
    data class Charge(val unit: Long, val direction: Vec2)
    data class Rout(val unit: Long)
    data class SkillActivated(val general: Long, val skill: String, val effect: String)
    data class GeneralDuel(val a: Long, val b: Long, val winner: Long?)
    data class WallBreached(val section: Int)
    data class Reinforcement(val units: List<Long>)
}
```

### 2B. ì „íˆ¬ í˜ì´ì¦ˆ

```
1. DEPLOY (ë°°ì¹˜) â”€â”€â”€ ì–‘ì¸¡ ìœ ë‹› ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
      â†“                (interactive ëª¨ë“œ: í”Œë ˆì´ì–´ê°€ ë°°ì¹˜ ì¡°ì‘)
2. ENGAGE (ì ‘ê·¼) â”€â”€â”€ ê¶ë³‘ ì‚¬ê±°ë¦¬ ì§„ì…, ì›ê±°ë¦¬ ê³µê²© ì‹œì‘
      â†“
3. MELEE (ê·¼ì ‘) â”€â”€â”€â”€ ë³´ë³‘/ê¸°ë³‘ ì¶©ëŒ, ì¥ìˆ˜ ì¼ê¸°í†  ë°œìƒ ê°€ëŠ¥
      â†“
4. RETREAT/END â”€â”€â”€â”€ ì‚¬ê¸° 0 â†’ íŒ¨ì£¼, ì „ë©¸, ë˜ëŠ” ì‹œê°„ ì´ˆê³¼
```

### 2C. ì‚¼êµ­ì§€ ìš”ì†Œ â†’ ì „íˆ¬ ë§¤í•‘

| í„´ì œ ìŠ¤íƒ¯ | ì „íˆ¬ ì˜í–¥ |
|----------|----------|
| **ë¬´ë ¥** | ìœ ë‹› ê³µê²©ë ¥, ì¼ê¸°í†  ìŠ¹ë¥  |
| **ì§€ë ¥** | ê³„ëµ ë°œë™ë¥  (í™”ê³„, ì„ ë™ ë“±) |
| **í†µì†”** | ìœ ë‹› ì‚¬ê¸° ìœ ì§€, ì§„í˜• íš¨ìœ¨ |
| **ë³‘ì¢…** | ìœ ë‹› íƒ€ì…, ìƒì„± (ê¸°ë³‘>ê¶ë³‘>ë³´ë³‘>ê¸°ë³‘) |
| **í›ˆë ¨ë„** | ìœ ë‹› ëª…ì¤‘ë¥ , íšŒí”¼ |
| **ì‚¬ê¸°** | ì´ˆê¸° ì‚¬ê¸°, íŒ¨ì£¼ ì„ê³„ê°’ |
| **ì„±ë²½** | ê³µì„±ì „: ë°©ì–´ë²½ HP, ì„±ë¬¸ |
| **ì§€í˜•** | ì‚°/í‰ì§€/ìˆ˜ì¤‘ â†’ ì´ë™ì†ë„, ë°©ì–´ ë³´ë„ˆìŠ¤ |
| **ì¥ë¹„** | ì¥ìˆ˜ ê°œì¸ ìŠ¤íƒ¯ ë³´ì • |
| **ì „íˆ¬íŠ¹ê¸°** | ê³ ìœ  ìŠ¤í‚¬ íŠ¸ë¦¬ê±° |

---

## 3. í”„ë¡ íŠ¸ì—”ë“œ ë Œë”ë§

### 3A. ê¸°ìˆ  ìŠ¤íƒ

```
PixiJS 8 (2D WebGL ë Œë”ëŸ¬)
  + @pixi/spritesheet (ìŠ¤í”„ë¼ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜)
  + @pixi/particle-emitter (ì´í™íŠ¸)

Next.js ì»´í¬ë„ŒíŠ¸ë¡œ ë˜í•‘:
  <BattleViewer ticks={data} speed={1} />
```

### 3B. í™”ë©´ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ì¥ìˆ˜A ì´ˆìƒ]  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  vs  â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  [ì¥ìˆ˜B ì´ˆìƒ]  â”‚
â”‚   HP/ì‚¬ê¸° ë°”                        HP/ì‚¬ê¸° ë°”              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚     ğŸ°                          âš”ï¸  âš”ï¸        â”‚
â”‚     ì„±ë²½        ğŸğŸğŸ    ğŸ—¡ï¸ğŸ—¡ï¸ğŸ—¡ï¸            â”‚
â”‚               ê¸°ë³‘ëŒ€      ë³´ë³‘ëŒ€              â”‚
â”‚                                              â”‚
â”‚          ğŸ¹ğŸ¹ğŸ¹          ğŸ¹ğŸ¹               â”‚
â”‚          ê¶ë³‘ëŒ€            ê¶ë³‘ëŒ€             â”‚
â”‚                                              â”‚
â”‚   [ì§€í˜•: í‰ì•¼]     [ë‚ ì”¨: ë§‘ìŒ]               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–¶ï¸ â¸ï¸  â©x1  â©x2  â©x4  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 35%      â”‚
â”‚  [ì „íˆ¬ ë¡œê·¸: ê´€ìš°ì˜ ê¸°ë³‘ëŒ€ê°€ ëŒê²©! 320 í”¼í•´]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3C. í”„ë¡ íŠ¸ì—”ë“œ ì§„ì…ì 

```tsx
// frontend/src/app/(game)/battle/page.tsx (ì´ë¯¸ ì¡´ì¬)

// ê¸°ì¡´: ì „íˆ¬ ê²°ê³¼ í…ìŠ¤íŠ¸ í‘œì‹œ
// í™•ì¥: ì „íˆ¬ ì‹œë®¬ë ˆì´ì…˜ ë¦¬í”Œë ˆì´ ë·°ì–´ ì¶”ê°€

export default function BattlePage() {
  const { battleId } = useParams()
  const { data } = useBattleData(battleId)
  
  if (data.ticks) {
    return <BattleReplayViewer ticks={data.ticks} result={data.result} />
  }
  // fallback: ê¸°ì¡´ í…ìŠ¤íŠ¸ ê²°ê³¼
  return <BattleResultText result={data.result} />
}
```

---

## 4. í„´ì œ ì—®ê¸°: êµ¬ì²´ì  ì‹œë‚˜ë¦¬ì˜¤

### 4A. ì¼ë°˜ ì•¼ì „

```
í„´ì œ: che_ì¶œë³‘ â†’ ì´ë™ì™„ë£Œ â†’ ì  ë„ì‹œ ì ‘ê·¼
ì „íˆ¬: í‰ì•¼/ì‚°ì§€ ë§µ ìƒì„± â†’ ì–‘ì¸¡ ë°°ì¹˜ â†’ ì‹œë®¬ë ˆì´ì…˜
í„´ì œ: ìŠ¹ë¦¬ â†’ ë„ì‹œ ì ë ¹ / íŒ¨ë°° â†’ ê·€í™˜
```

### 4B. ê³µì„±ì „

```
í„´ì œ: ì  ë„ì‹œ ë„ì°© (ì„±ë²½ > 0)
ì „íˆ¬: ê³µì„± ë§µ ìƒì„± (ì„±ë²½+ì„±ë¬¸) â†’ ê³µê²©ì¸¡: ì„±ë²½ ë¶€ìˆ˜ê¸° â†’ ëŒì…
í„´ì œ: ì„±ë²½ HP ê°ì†Œ ë°˜ì˜, ë„ì‹œ ì ë ¹ ì—¬ë¶€
```

### 4C. ìˆ˜ë¹„ì „ (NPC ìë™)

```
í„´ì œ: ì ì´ ë‚´ ë„ì‹œ ê³µê²©
ì „íˆ¬: auto ëª¨ë“œë¡œ ì¦‰ì‹œ íŒì • (ê¸°ì¡´ ë°©ì‹)
     â†’ í”Œë ˆì´ì–´ê°€ ë‚˜ì¤‘ì— "ë¦¬í”Œë ˆì´" ë²„íŠ¼ìœ¼ë¡œ ì‹œì²­ ê°€ëŠ¥
```

### 4D. ì¼ê¸°í†  (ì¥ìˆ˜ ëŒ€ê²°)

```
ì „íˆ¬ ì¤‘ MELEE í˜ì´ì¦ˆ:
  â†’ ì–‘ì¸¡ ì¥ìˆ˜ ë¬´ë ¥ ë¹„êµ â†’ í™•ë¥ ì  ì¼ê¸°í†  íŠ¸ë¦¬ê±°
  â†’ ë¯¸ë‹ˆ ì´ë²¤íŠ¸: 3~5í‹±ì§œë¦¬ ì§§ì€ ì•¡ì…˜ ì‹œí€€ìŠ¤
  â†’ íŒ¨ë°° ì¥ìˆ˜: ë¶€ìƒ/í¬ë¡œ/ì‚¬ë§
```

### 4E. ê³„ëµ ì—°ë™

```
í„´ì œì—ì„œ ë¯¸ë¦¬ ì‹¤í–‰í•œ ì»¤ë§¨ë“œê°€ ì „íˆ¬ì— ì˜í–¥:
  - che_í™”ê³„ â†’ ì „íˆ¬ ì‹œì‘ ì‹œ í™”ê³µ ì´ë²¤íŠ¸ (ì  ì‚¬ê¸° -20, HP -10%)
  - che_ì„ ë™ â†’ ì  ìœ ë‹› ì´ˆê¸° ì‚¬ê¸° ê°ì†Œ
  - che_ì²©ë³´ â†’ ì  ë°°ì¹˜ ë¯¸ë¦¬ ê³µê°œ (interactive ëª¨ë“œ)
  - che_ìˆ˜ë¹„ê°•í™” â†’ ì„±ë²½ HP ë³´ë„ˆìŠ¤
```

---

## 5. ë°ì´í„° í”Œë¡œìš°

```
[í„´ì œ ì»¤ë§¨ë“œ]
     â”‚
     â–¼
[BattleScenarioBuilder]  â† ì¥ìˆ˜/ë³‘ë ¥/ë„ì‹œ/ì§€í˜• ë°ì´í„° ì¡°í•©
     â”‚
     â–¼
[BattleSimulator]  â† í‹± ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜ (ì„œë²„)
     â”‚
     â”œâ”€â†’ BattleResult (ìŠ¹íŒ¨/ì†ì‹¤) â†’ í„´ì œ ì‹œìŠ¤í…œì— ë°˜ì˜
     â”‚
     â””â”€â†’ List<BattleTick> (ë¦¬í”Œë ˆì´ ë°ì´í„°) â†’ DB ì €ì¥
                                                â”‚
                                                â–¼
                                    [í”„ë¡ íŠ¸: GET /api/battle/{id}/ticks]
                                                â”‚
                                                â–¼
                                    [PixiJS Canvas ë¦¬í”Œë ˆì´]
```

---

## 6. DB ìŠ¤í‚¤ë§ˆ (ì¶”ê°€)

```sql
CREATE TABLE battle_record (
    id BIGSERIAL PRIMARY KEY,
    world_id BIGINT NOT NULL,
    turn INT NOT NULL,
    attacker_general_id BIGINT NOT NULL,
    defender_general_id BIGINT,
    attacker_nation_id BIGINT,
    defender_nation_id BIGINT,
    city_id BIGINT NOT NULL,
    battle_type VARCHAR(20) NOT NULL,  -- FIELD, SIEGE, DUEL
    winner VARCHAR(10) NOT NULL,        -- ATTACKER, DEFENDER, DRAW
    attacker_loss JSONB,
    defender_loss JSONB,
    ticks_data JSONB,                   -- ì „ì²´ í‹± ë°ì´í„° (ì••ì¶•)
    tick_count INT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_battle_record_world_turn ON battle_record(world_id, turn);
CREATE INDEX idx_battle_record_general ON battle_record(attacker_general_id);
```

---

## 7. êµ¬í˜„ ìš°ì„ ìˆœìœ„

| ë‹¨ê³„ | ë‚´ìš© | ì˜ì¡´ì„± |
|------|------|--------|
| **S1** | BattleScenarioBuilder â€” í„´ì œâ†’ì „íˆ¬ íŒŒë¼ë¯¸í„° ë³€í™˜ | Phase 1 ì™„ë£Œ í›„ |
| **S2** | BattleSimulator â€” í‹± ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„ | S1 |
| **S3** | battle_record í…Œì´ë¸” + API | S2 |
| **S4** | PixiJS ë¦¬í”Œë ˆì´ ë·°ì–´ (replay ëª¨ë“œ) | S3 |
| **S5** | ë°°ì¹˜ ì¡°ì‘ UI (interactive ëª¨ë“œ) | S4 |
| **S6** | WebSocket ì‹¤ì‹œê°„ ì „íˆ¬ | S5 (ì„ íƒ) |

---

## 8. ë¦¬ìŠ¤í¬ & ê²°ì • ì‚¬í•­

- [ ] ì „íˆ¬ í‹± ë°ì´í„° í¬ê¸° â€” JSONB vs ë³„ë„ íŒŒì¼? (í° ì „íˆ¬ = ìˆ˜ì²œ í‹±)
- [ ] NPC ì „íˆ¬ ì „ë¶€ ì‹œë®¬ë ˆì´ì…˜? â†’ ì„œë²„ ë¶€í•˜. auto ëª¨ë“œ ìœ ì§€ ê¶Œì¥
- [ ] í”Œë ˆì´ì–´ ì¡°ì‘ ë²”ìœ„ â€” ì§„í˜•ë§Œ? ê°œë³„ ìœ ë‹› ì´ë™ê¹Œì§€?
- [ ] ëª¨ë°”ì¼ ëŒ€ì‘ â€” Canvas ì„±ëŠ¥ ê´œì°®ì€ì§€
- [ ] PixiJS vs Phaser â€” PhaserëŠ” ë¬´ê²ì§€ë§Œ ê¸°ëŠ¥ å¤š, PixiJSëŠ” ê°€ë³ê³  ì¶©ë¶„

---

*ì´ ë¬¸ì„œëŠ” ì„¤ê³„ ì°¸ì¡°ìš©. ê°œë°œì€ Phase 4 ì´í›„.*
